var B=Object.defineProperty;var W=(n,t,e)=>t in n?B(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var o=(n,t,e)=>(W(n,typeof t!="symbol"?t+"":t,e),e),A=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var c=(n,t,e)=>(A(n,t,"read from private field"),e?e.call(n):t.get(n)),y=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},f=(n,t,e,s)=>(A(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e);const j=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=e(i);fetch(i.href,r)}};j();function X(n=Math.random()*1e13){var t=4294967295,e=123456789+n&t,s=987654321-n&t;return function(){s=36969*(s&65535)+(s>>>16)&t,e=18e3*(e&65535)+(e>>>16)&t;var i=(s<<16)+(e&65535)>>>0;return i/=4294967296,i}}let L=+location.hash.slice(1)|0,U=Math.random();const I=()=>{location.hash=`#${L=U*1e8|0}`};(!L||isNaN(L))&&I();const N=X(L);U=N();const K=(n,t)=>{for(const e in n)typeof n[e]=="object"?K(n[e],t[e]):t[e]=n[e]},v=(n,t={},...e)=>{const s=document.createElement(n);K(t,s);for(const i of e)s.appendChild(i);return s};class G{constructor(t,e){this.x=t,this.y=e}}function x(n,t){return new G(n,t)}class H{constructor(t,e){o(this,"width",0);o(this,"height",0);o(this,"map");this.map=new Uint8Array(t*e),this.width=t,this.height=e}get clonedMap(){return new Uint8Array(this.map)}entries(){const{width:t,map:e}=this,s=new Array(e.length);for(let i=0;i<e.length;i++){let r=i%t,h=(i-r)/t,a=e[i];s[i]=[r,h,a]}return s}index(t){const{width:e,height:s}=this;if(t instanceof G){const{x:i,y:r}=t;return i<0||i>e-1||r<0||r>s-1?-1:r*this.width+i}return t}get(t){return this.map[this.index(t)]}set(t,e){return this.map[this.index(t)]=e|0}getRow(t){return t<0||t>=this.height?new Uint8Array(this.width):(t*=this.width,this.map.slice(t,t+this.width))}setRow(t,e){t*=this.width,this.map.set(e,t)}}const z=class extends H{constructor(){super(...arguments);o(this,"x",0);o(this,"y",0);o(this,"delta",0);o(this,"previewState",{x:this.x,y:this.y,map:this.clonedMap})}getMinY(){let e=1/0;for(let s=0;s<this.width;s++)for(let i=0;i<this.height;i++)if(this.get(x(s,i))&&i<e){e=i;break}return e}getMaxY(){let e=-1/0;for(let s=0;s<this.width;s++)for(let i=this.height-1;i>=0;i--)if(this.get(x(s,i))&&i>e){e=i;break}return e}static make(...e){var a;let s=1,i=e.length,r=0;for(let l of e)l.length>r&&(r=l.length);const h=new z(r,i);for(let[l,p]of h.entries()){const m=((a=e[p])==null?void 0:a[l])||" ";h.set(x(l,p),m==" "?0:s)}return h}save(){this.previewState={x:this.x,y:this.y,map:this.clonedMap}}back(){this.x=this.previewState.x,this.y=this.previewState.y,this.map=this.previewState.map}move(e,s){return this.save(),this.x+=e,this.y+=s,s&&(this.delta=1),this}haveCollizion(e,s=!1){for(let[i,r,h]of this.entries())if(!!h&&(i+=this.x,r+=this.y,i<0||i>=e.width||s&&r<0||r>=e.height||e.get(x(i,r))))return!0;return!1}rotate(){this.save();const e=this.clone(),{height:s,width:i}=this;this.width=s,this.height=i;for(let[r,h,a]of e.entries())this.set(x(s-1-h,r),a);return this}clone(){const{width:e,height:s}=this,i=new z(e,s);return i.x=this.x,i.y=this.y,i.map=this.clonedMap,i}color(e=1){for(let[s,i,r]of this.entries())this.set(x(s,i),r?e:0);return this}position(e,s){return this.x=e,this.y=s,this}};let u=z;o(u,"colors",["transparent","#00EEEE","#0008EE","#EE9500","#EEEE00","#00EE00","#9508EE","#EE0000"]);const J=u.make("    ","####","    ","    ").color(1),Z=u.make("##","##").color(4),Q=u.make("   ","###"," # ").color(6),V=u.make(" # "," # ","## ").color(2),_=u.make(" # "," # "," ##").color(3),ee=u.make(" ##","## ","   ").color(5),te=u.make("## "," ##","   ").color(7),D=[J,Z,Q,V,_,ee,te];function F(){let n=N()*4|0;const t=D[N()*D.length|0].clone();for(;n--;)t.rotate();return t}class O extends H{constructor(e=10,s=20){super(e,s);o(this,"figures",[])}entriesRender(){return this.entries().map(([e,s,i])=>{for(let r of this.figures){if(e<r.x||e>r.x+r.width||s<r.y||s>r.y+r.height)continue;const h=r.get(x(e-r.x,s-r.y));typeof h=="number"&&(i=i||h)}return[e,s,i]})}add(e){const{figures:s}=this;s.indexOf(e)==-1&&s.push(e)}remove(e){if(!e){this.figures.splice(0);return}const{figures:s}=this,i=s.indexOf(e);i!=-1&&s.splice(i,1)}fix(e){this.remove(e);for(let[s,i,r]of e.entries())!r||(s+=e.x,i+=e.y,this.set(x(s,i),r))}checkClear(){let e=0;for(let s=this.height-1;s-e>=-1;s--)this.getRow(s-e).every(Boolean)&&e++,e&&this.setRow(s,this.getRow(s-e));return e}}class P{constructor(t){o(this,"elem",document.createElement("canvas"));o(this,"ctx",this.elem.getContext("2d"));o(this,"size",20);o(this,"padding",30);o(this,"time",performance.now());o(this,"deltaTime",0);this.map=t;const{size:e}=this,{width:s,height:i}=t,r=s*e,h=i*e;this.elem.width=r,this.elem.height=h,this.elem.style.width=`${r}px`,this.elem.style.height=`${h}px`,this.elem.style.border="2px solid #999",this.elem.style.imageRendering="pixelated"}append(t){if(t instanceof HTMLElement){t.appendChild(this.elem);return}const e=document.querySelector(t);if(!e)throw new Error("No find element!");return this.append(e)}render(){const{size:t,ctx:e,map:s,time:i}=this,{width:r,height:h}=this.map,a=performance.now();this.deltaTime=a-i,this.time=a,this.deltaTime>100&&(this.deltaTime=0),e.clearRect(0,0,r*t,h*t);for(let[l,p,m]of s.entries()){const g=u.colors[m]||"transparent",w=l*t,S=p*t;e.beginPath(),e.strokeStyle="#dddddd",e.fillStyle=g,e.strokeRect(w,S,t,t),e.fillRect(w+1,S+1,t-1,t-1),e.closePath()}for(let l of s.figures){let{x:p,y:m}=l;p*=t,m*=t;for(let[g,w,S]of l.entries()){const M=u.colors[S]||"transparent",q=l.delta*t;g*=t,w*=t,e.beginPath(),e.strokeStyle="#dddddd",e.fillStyle=M,e.fillRect(g+p+1,w+m-q+1,t-1,t-1),e.closePath()}l.delta>0?l.delta-=.15:l.delta=0}}}const $=new Map;addEventListener("keydown",({code:n})=>{$.set(n,!0)});addEventListener("keyup",({code:n})=>{$.set(n,!1)});var C,b,k;class ie{constructor(t){y(this,C,void 0);y(this,b,!1);y(this,k,0);f(this,C,t)}isDown(){return!!c(this,C).filter(t=>$.get(t)).length}isUp(){return!this.isDown()}isSingle(){return!c(this,b)&&this.isDown()?(f(this,b,!0),!0):(this.isDown()||f(this,b,!1),!1)}isEvery(t=0){const e=performance.now();return this.isDown()?c(this,k)?c(this,k)+t<e?(f(this,k,e),!0):!1:(f(this,k,e),!0):(f(this,k,0),!1)}}C=new WeakMap,b=new WeakMap,k=new WeakMap;const se=n=>Object.entries(n).reduce((t,[e,s])=>(t[e]=new ie(s),t),{});var Y,E,d,T,R;class re{constructor(t){y(this,E,0);y(this,d,0);y(this,T,+((Y=localStorage.getItem("hiscore"))!=null?Y:"0"));y(this,R,se({keyUp:["ArrowUp","KeyW"],keyDown:["ArrowDown","KeyS"],keyLeft:["ArrowLeft","KeyA"],keyRight:["ArrowRight","KeyD"],pause:["Escape","Space"]}));o(this,"appendScores",[0,100,300,700,1500]);o(this,"figure");o(this,"nexFigure");o(this,"map",new O);o(this,"next",new O(4,4));o(this,"renderer",new P(this.map));o(this,"rendererNext",new P(this.next));o(this,"work",!1);o(this,"isDown",!1);o(this,"pause",!0);o(this,"tickCount",0);o(this,"previewTick",performance.now());o(this,"previewMove",performance.now());o(this,"previewTime",performance.now());o(this,"gapElement",v("div",{className:"gap"}));o(this,"scoreElement",v("p",{className:"score",innerText:`${this.score}`}));o(this,"hiScoreElement",v("p",{className:"score",innerText:`${c(this,T)}`}));o(this,"linesElement",v("p",{className:"score",innerText:`${c(this,d)}`}));o(this,"levelElement",v("p",{className:"score",innerText:`${c(this,d)/10|0}`}));o(this,"pauseElement",v("p",{className:"pause",innerText:"\u041F\u0430\u0443\u0437\u0430 (Esc | Space)"}));o(this,"pauseButton",v("button",{innerText:"\u041F\u0430\u0443\u0437\u0430 (Esc)"}));o(this,"githubLink",v("a",{href:"https://github.com/vicimpa/tetris",innerText:"GitHub"}));const e=document.querySelector(t),s=e.querySelector("#content"),i=e.querySelector("#side");this.newFigure(),this.renderer.append(s),i.appendChild(this.scoreElement),i.appendChild(this.hiScoreElement),i.appendChild(this.linesElement),i.appendChild(this.levelElement),this.rendererNext.append(i),i.appendChild(this.pauseButton),s.appendChild(this.pauseElement),this.resize(e),i.appendChild(this.gapElement),i.appendChild(this.githubLink),addEventListener("resize",this.resize.bind(this,e)),addEventListener("blur",()=>this.pause=!0),this.pauseButton.addEventListener("click",()=>this.pause=!this.pause)}get score(){return c(this,E)}set score(t){f(this,E,t),this.scoreElement.innerText=`${t}`,c(this,E)>c(this,T)&&(f(this,T,c(this,E)),this.hiScoreElement.innerText=`${c(this,T)}`,localStorage.setItem("hiscore",`${c(this,E)}`))}get lines(){return c(this,d)}set lines(t){f(this,d,t),this.linesElement.innerText=`${c(this,d)}`,this.levelElement.innerText=`${c(this,d)/10|0}`}get speed(){return 600-(c(this,d)/10|0)*15}resize(t){const{parentElement:s}=t;if(!s)return;const{offsetWidth:i,offsetHeight:r}=s,{offsetWidth:h,offsetHeight:a}=t,l=Math.min((i-20*2)/h,(r-20*2)/a);t.style.transform=`scale(${l})`}rotate(){this.figure.rotate(),this.figure.haveCollizion(this.map)&&this.figure.back(),this.renderer.render()}move(t){this.figure.move(t,0),this.figure.haveCollizion(this.map)&&this.figure.back(),this.renderer.render()}newFigure(){var s;this.figure&&this.map.remove(this.figure),this.figure=(s=this.nexFigure)!=null?s:F(),this.nexFigure=F(),this.next.remove(),this.next.add(this.nexFigure),this.map.add(this.figure);const t=-this.figure.height+this.figure.getMinY(),e=Math.round(this.map.width/2-this.figure.width/2);this.figure.position(e,t),this.renderer.render(),this.rendererNext.render()}start(){this.work||(this.work=!0,this.tick())}stop(){!this.work||(this.work=!1)}checkPause(){const t="show",{classList:e}=this.pauseElement;this.pause&&!e.contains(t)&&e.add(t),!this.pause&&e.contains(t)&&e.remove(t)}tick(){var S;if(!this.work)return;const{keyUp:t,keyDown:e,keyLeft:s,keyRight:i,pause:r}=c(this,R);requestAnimationFrame(()=>this.tick());const{figure:h}=this,a=performance.now(),l=a-this.previewTime;this.previewTime=a,l>100&&!this.pause&&(this.pause=!0),r.isSingle()&&(this.pause=!this.pause),this.checkPause();const{previewTick:p,previewMove:m}=this;if(this.pause){this.previewTick=a,this.previewMove=a;return}let g=this.speed,w=100;if(e.isDown()&&(g*=.1),t.isSingle()&&this.rotate(),(s.isSingle()||i.isSingle())&&(this.previewMove=a),e.isSingle()&&(this.previewTick=a-g),a>=m+w&&(s.isDown()?(this.move(-1),this.previewMove=a):i.isDown()?(this.move(1),this.previewMove=a):this.previewMove=a-w),a>=p+g&&(this.tickCount+=1,this.previewTick=a,h.move(0,1),h.haveCollizion(this.map))){if(h.back(),this.figure.haveCollizion(this.map,!0)){this.stop(),alert(`Game Over! Score ${this.score}`),I(),location.reload();return}this.map.fix(this.figure);const M=this.map.checkClear();this.lines+=M,this.score+=(S=this.appendScores[M])!=null?S:1e4,this.newFigure()}this.renderer.render()}}E=new WeakMap,d=new WeakMap,T=new WeakMap,R=new WeakMap;new re("#app").start();
